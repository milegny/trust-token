<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrustToken Admin - Advanced</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .btn { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .btn:hover { background: #5568d3; }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 50px auto; padding: 30px; border-radius: 12px; max-width: 600px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f5f5f5; font-weight: 600; }
        .actions { display: flex; gap: 10px; }
        .search-box { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; margin-bottom: 20px; }
        .notification { position: fixed; top: 20px; right: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 2000; min-width: 300px; animation: slideIn 0.3s; }
        .notification.success { border-left: 4px solid #28a745; }
        .notification.error { border-left: 4px solid #dc3545; }
        .notification.info { border-left: 4px solid #667eea; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> TrustToken Admin - Advanced</h1>
            <p>Complete Management Dashboard</p>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Quick Actions</h3>
                <button class="btn" onclick="showCreateProduct()"><i class="fas fa-plus"></i> New Product</button>
                <button class="btn btn-success" onclick="exportData('json')"><i class="fas fa-download"></i> Export JSON</button>
                <button class="btn btn-success" onclick="exportData('csv')"><i class="fas fa-file-csv"></i> Export CSV</button>
            </div>
            <div class="card">
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h3>Activity Logs</h3>
            <div id="activityLogs" style="max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px;"></div>
        </div>

        <div class="card">
            <h3>Products Management</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" class="search-box" placeholder="Search products..." onkeyup="applyFilters()" id="searchInput" style="flex: 1;">
                <select class="search-box" onchange="applyFilters()" id="categoryFilter" style="width: 200px;">
                    <option value="">All Categories</option>
                </select>
                <select class="search-box" onchange="applyFilters()" id="stockFilter" style="width: 200px;">
                    <option value="">All Stock</option>
                    <option value="low">Low Stock (&lt;10)</option>
                    <option value="medium">Medium Stock (10-50)</option>
                    <option value="high">High Stock (&gt;50)</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn" onclick="selectAll()"><i class="fas fa-check-square"></i> Select All</button>
                <button class="btn btn-danger" onclick="bulkDelete()"><i class="fas fa-trash"></i> Delete Selected</button>
                <span id="selectedCount" style="padding: 10px; font-weight: 600;">0 selected</span>
            </div>
            <table id="productsTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" onchange="toggleAll(this)"></th>
                        <th onclick="sortBy('name')" style="cursor: pointer;">Name ↕</th>
                        <th onclick="sortBy('price')" style="cursor: pointer;">Price ↕</th>
                        <th onclick="sortBy('stock')" style="cursor: pointer;">Stock ↕</th>
                        <th>Category</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productsBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Create Product Modal -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <h2>Create Product</h2>
            <form id="productForm">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="productDesc" required></textarea>
                </div>
                <div class="form-group">
                    <label>Price</label>
                    <input type="number" id="productPrice" required>
                </div>
                <div class="form-group">
                    <label>Stock</label>
                    <input type="number" id="productStock" required>
                </div>
                <button type="submit" class="btn">Create</button>
                <button type="button" class="btn btn-danger" onclick="closeModal()">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        const API = window.location.origin;
        let allProducts = [];
        let currentEditId = null;

        async function loadProducts() {
            const res = await fetch(`${API}/api/products?limit=100`);
            const data = await res.json();
            allProducts = data.products || [];
            displayProducts(allProducts);
            updateChart();
            populateCategories();
        }

        function populateCategories() {
            const categories = [...new Set(allProducts.map(p => p.category))];
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="">All Categories</option>' +
                categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        let selectedProducts = new Set();

        function displayProducts(products) {
            const tbody = document.getElementById('productsBody');
            tbody.innerHTML = products.map(p => `
                <tr>
                    <td><input type="checkbox" class="product-checkbox" data-id="${p.id}" onchange="updateSelection()"></td>
                    <td>${p.name}</td>
                    <td>$${p.price} ${p.currency || 'SOL'}</td>
                    <td style="color: ${p.stock < 10 ? 'red' : p.stock < 50 ? 'orange' : 'green'}">${p.stock}</td>
                    <td>${p.category}</td>
                    <td class="actions">
                        <button class="btn" onclick="editProduct('${p.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger" onclick="deleteProduct('${p.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function toggleAll(checkbox) {
            document.querySelectorAll('.product-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateSelection();
        }

        function updateSelection() {
            selectedProducts.clear();
            document.querySelectorAll('.product-checkbox:checked').forEach(cb => {
                selectedProducts.add(cb.dataset.id);
            });
            document.getElementById('selectedCount').textContent = `${selectedProducts.size} selected`;
        }

        function selectAll() {
            document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = true);
            updateSelection();
        }

        async function bulkDelete() {
            if (selectedProducts.size === 0) {
                showNotification('No products selected', 'error');
                return;
            }
            if (confirm(`Delete ${selectedProducts.size} products?`)) {
                for (const id of selectedProducts) {
                    await fetch(`${API}/api/products/${id}`, { method: 'DELETE' });
                }
                selectedProducts.clear();
                loadProducts();
            }
        }

        function applyFilters() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;

            let filtered = allProducts.filter(p => {
                const matchesSearch = !searchQuery || 
                    p.name.toLowerCase().includes(searchQuery) ||
                    p.description.toLowerCase().includes(searchQuery);
                
                const matchesCategory = !category || p.category === category;
                
                let matchesStock = true;
                if (stockFilter === 'low') matchesStock = p.stock < 10;
                else if (stockFilter === 'medium') matchesStock = p.stock >= 10 && p.stock <= 50;
                else if (stockFilter === 'high') matchesStock = p.stock > 50;

                return matchesSearch && matchesCategory && matchesStock;
            });

            displayProducts(filtered);
        }

        let sortDirection = {};
        function sortBy(field) {
            sortDirection[field] = !sortDirection[field];
            const sorted = [...allProducts].sort((a, b) => {
                if (sortDirection[field]) {
                    return a[field] > b[field] ? 1 : -1;
                } else {
                    return a[field] < b[field] ? 1 : -1;
                }
            });
            displayProducts(sorted);
        }

        function showCreateProduct() {
            currentEditId = null;
            document.getElementById('productForm').reset();
            document.querySelector('#createModal h2').textContent = 'Create Product';
            document.getElementById('createModal').style.display = 'block';
        }

        async function editProduct(id) {
            currentEditId = id;
            const product = allProducts.find(p => p.id === id);
            if (product) {
                document.getElementById('productName').value = product.name;
                document.getElementById('productDesc').value = product.description;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productStock').value = product.stock;
                document.querySelector('#createModal h2').textContent = 'Edit Product';
                document.getElementById('createModal').style.display = 'block';
            }
        }

        function closeModal() {
            document.getElementById('createModal').style.display = 'none';
            currentEditId = null;
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDesc').value,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
            };

            if (currentEditId) {
                await fetch(`${API}/api/products/${currentEditId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                const users = await fetch(`${API}/api/users`).then(r => r.json());
                const seller = users.users?.[0];
                if (!seller) {
                    alert('No seller found. Please create a user first.');
                    return;
                }
                data.sellerId = seller.id;
                data.category = 'General';
                data.images = [];
                await fetch(`${API}/api/products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }
            closeModal();
            loadProducts();
        });

        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                await fetch(`${API}/api/products/${id}`, { method: 'DELETE' });
                loadProducts();
            }
        }

        function exportData(format) {
            if (format === 'json') {
                const blob = new Blob([JSON.stringify(allProducts, null, 2)], { type: 'application/json' });
                downloadFile(blob, 'products.json');
            } else if (format === 'csv') {
                const csv = convertToCSV(allProducts);
                const blob = new Blob([csv], { type: 'text/csv' });
                downloadFile(blob, 'products.csv');
            }
        }

        function convertToCSV(data) {
            const headers = ['Name', 'Description', 'Price', 'Stock', 'Category'];
            const rows = data.map(p => [
                `"${p.name}"`,
                `"${p.description}"`,
                p.price,
                p.stock,
                p.category
            ]);
            return [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        let chartInstance = null;
        function updateChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: allProducts.slice(0, 10).map(p => p.name.substring(0, 15)),
                    datasets: [{
                        label: 'Stock Level',
                        data: allProducts.slice(0, 10).map(p => p.stock),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
        }

        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.innerHTML = `
                <strong>${type.toUpperCase()}</strong>
                <p>${message}</p>
            `;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        const activityLogs = [];
        function logActivity(message) {
            const timestamp = new Date().toLocaleTimeString();
            activityLogs.unshift(`[${timestamp}] ${message}`);
            if (activityLogs.length > 50) activityLogs.pop();
            
            const logsDiv = document.getElementById('activityLogs');
            logsDiv.innerHTML = activityLogs.map(log => `<div>${log}</div>`).join('');
        }

        const originalFetch = window.fetch;
        window.fetch = async (...args) => {
            try {
                const response = await originalFetch(...args);
                const method = args[1]?.method || 'GET';
                const url = args[0].toString();
                
                if (response.ok && method !== 'GET') {
                    const action = method === 'POST' ? 'Created' : method === 'PUT' ? 'Updated' : method === 'DELETE' ? 'Deleted' : 'Modified';
                    logActivity(`${action} resource: ${url.split('/').pop()}`);
                    showNotification(`Operation completed successfully`, 'success');
                }
                return response;
            } catch (error) {
                logActivity(`ERROR: ${error.message}`);
                showNotification(`Error: ${error.message}`, 'error');
                throw error;
            }
        };

        loadProducts();
    </script>
</body>
</html>
